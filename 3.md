1) افصل بين “تنضيف النص” و “Features بتاعة الفورمات”

دلوقتي أنت بتعمل normalizeLine() وبعدين بتبعت الناتج للتصنيف. ده مفيد… بس ليه side-effect مهم:

normalizeLine بيشيل الشرطة في أول السطر ضمن إزالة الـ bullets:

.replace(/^[...]*[•...*+\-]+/, "")


وده بيضيّع “إشارة فورمات” قوية… خصوصًا إن عندك جوّه scoreAsAction قاعدة بتقول:
“لو يبدأ بشرطة يبقى أكشن”
بس هي عمرها مش هتشتغل لأن الشرطة اتشالت قبل ما توصل للدالة.

الحل

خليك دايمًا ماسك نسختين من السطر:

rawLine (زي ما الكاتب كتبه)

normalizedLine (للتحليل اللغوي)

وبعدين:

استخدم normalizedLine لمعظم الـ regex/الـ tokens

واستخدم rawLine لحاجات زي:
leading dash / indentation / capitalization / علامات ASCII

اقتراح سريع للتعديل:
بدل ما تبعت cleanedCurrent لـ classifyWithScoring، ابعت rawLine وخلي الدالة نفسها تعمل normalization داخليًا.

2) خلّي عندك “وضع احتياط” رسمي: Ambiguous / NeedsReview

أنت بالفعل عامل doubtScore… بس في classifyBatch أنت بتاخد result.type وبس، وبتتجاهل الشك.

ده كنز. لأن 80% من حالات “الكاتب كاتب غلط” هتطلع عندك كـ:

أعلى نوع = X

ثاني أعلى نوع = قريب جدًا من X
=> “غموض”

اللي أنصح به

لو doubtScore >= 60 (أو حسب ما تشوف)
ما ترميش نوع واحد وخلاص.

رجّع:

type

confidence

doubtScore

top2Candidates مع الأسباب

وبعدين عند الـ UI/الـ output:

علّم السطر إنه “محتاج مراجعة”

أو اعمل fallback ذكي:

لو متردد بين character و action و مافيش Dialogue بعده => رجّح action

لو متردد بين dialogue و action و قبلها Character => رجّح dialogue
… إلخ

ده هيخليك “تحتاط” بدون ما تزود قواعد عشوائية.

3) “فهم السياق” الحقيقي: اختار أفضل تسلسل Types للسطر كله (مش كل سطر لوحده)

أقوى ترقية ممكن تعملها (وبتليق جدًا على اللي عندك) هي:

استخدم Viterbi / HMM-style decoding

أنت أصلًا عندك “Emission scores” (نقاط لكل type لكل سطر).
اللي ناقصك: “Transition scores” (قواعد الانتقال بين الأنواع).

يعني بدل ما تقرر كل سطر لوحده:

قرر “أحسن مسار” عبر النص كله بحيث:

character -> dialogue انتقاله مرجّح

character -> character انتقاله ضعيف

scene-header -> action مرجّح

transition -> scene-header مرجّح

parenthetical غالبًا بين character و dialogue

وده بيحل تلقائيًا حاجات زي:

اسم شخصية بدون “:” (الكاتب ناسيها)

سطر قصير “ياسين” (يبدأ بـ يـ) مش لازم يتفسّر كفعل

Parenthetical في مكان غلط

Dialogue ابتلع action بالغلط

المغزى:
حتى لو سطر واحد ambiguous… السياق العام يثبّت القرار الصح.

أنت بالفعل عندك شبه Transition rules في getEnterSpacingRule… تقدر تستلهم منها Transition Matrix.

4) ذاكرة على مستوى المستند: “اتعلم من نفس السيناريو”

دي فكرة قوية جدًا ورخيصة:

4.1) اجمع أسماء الشخصيات تلقائيًا

أي سطر character بثقة عالية (خصوصًا اللي بينتهي بـ :) خزّنه في Set.

بعد كده:

لو قابلت سطر “ياسين” بدون :
والكلمة موجودة في knownCharacters
ارفع نقاط character جامد وخفّض action.

ده بيعالج مشكلة كبيرة جدًا عندك حاليًا بسبب matchesActionStartPattern اللي ممكن يبلع أسماء تبدأ بـ “ي/ت”.

4.2) اجمع “أماكن” من scene headers

لو مكان اتذكر كـ scene-header-3 أو جوه header… خزنه.
وبعد كده أي سطر قصير شبه “مكتب المدير” يترجّح كـ مكان مش شخصية.

4.3) اجمع “قوالب” الكاتب

في سكريبتات كتير الكاتب بيبقى consistent:

دايمًا يكتب Transition بنفس الكلمات

دايمًا يعمل dash قبل الأكشن

دايمًا يكتب character في سطر لوحده وبين سطرين فاضيين
… إلخ
ممكن تعمل “profiling” بسيط أول 1-2 صفحة وتظبط thresholds بناءً عليها.

5) تحسينات مهمّة لكل عنصر… بس بشكل “مقاوم للغلطات”
5.1) Scene Header

أكبر نقطة ضعف حاليًا: الـ headers اللي مش بتبدأ بـ “مشهد / م. / scene”
في ناس بتكتب:

داخلي - بيت - ليل

خارجي/ليل - شارع

INT. HOUSE - NIGHT (بالإنجليزي)

أنت عندك INOUT_PART و TIME_PART و TL_REGEX ممتازين… بس مش مستغلهم كـ “Start of scene” إلا لما فيه prefix.

فكرة:
اعمل ALT_SCENE_HEADER_RE:

يبدأ بـ (داخلي|خارجي|INT|EXT …)

يحتوي على dash/slash

ماينتهيش بعلامة جملة (., ؟, !)

WordCount أقل من حد معين

ومايبدأش بفعل

وبكده تقدر تلتقط رؤوس مشاهد “غير قياسية”.

كمان خد بالك من حالة “مشهد 1 - داخلي - بيت - ليل - أحمد يجلس”
عندك احتمال إن الـ remainder يتحسب place وهو فيه action.
حلها: لو remainder “بيبدأ بفعل/نمط حركة” اقسمه:
جزء place + سطر action جديد.

5.2) Character

هنا أهم حاجتين:

(أ) بلاش Regex واسع يبلع أي عربي

في isCharacterLine عندك:

const arabicCharacterPattern =
/^[\s\u0600-\u06FF...]+[:\s]*$/;


ده بيطابق “أي كلام عربي” تقريبًا… وده خطر.

بديل عملي:
خلي “Character بدون :” لازم يحقق شرطين مع بعض:

قصير جدًا (مثلاً <= 3 كلمات)

السطر اللي بعده “Dialogue-ish”

ومش فيه أفعال (مش بس أول كلمة… كمان الكلمة التانية)

(ب) مشكلة “ي/ت” (أسماء زي يوسف/ياسين)

matchesActionStartPattern عندك فيه patterns واسعة جدًا بتعتبر أي كلمة تبدأ بـ (ي/ت) فعلًا.
ده هيوقعك في أسماء شخصيات كتير.

حل بسيط جدًا:

امسح/عدّل أي pattern بيسمح بـ end-of-line بعد كلمة واحدة

خلي نمط الفعل لازم يكون وراه كلمة تانية (verb + شيء)

أو ادي exception: لو السطر كلمة واحدة والسطر التالي حوار يبقى character مش action

5.3) Parenthetical

أنت عامل quick classify لأي سطر بين قوسين => parenthetical 100%.
بس في الواقع فيه:

لقطة/تعليمات إخراج: (لقطة مقربة) دي مش “parenthetical تحت الشخصية”؛ دي أقرب لـ action/shot.

اقتراح:

لو السطر بين قوسين لكن اللي قبله مش character/dialogue
رجّحه action أو نوع جديد shot بدل parenthetical.

وادعم parenthetical “غير مكتمل”:

يبدأ بـ ( ومافيش ) → كمّل لحد ما تلاقي ) في سطر تالي

5.4) Dialogue

حلو إنك معتبر السياق (prev character/parenthetical).
بس في أخطاء كتابة شائعة:

الحوار يبدأ بـ - أو — (زي ترجمات)

أو يبدأ بـ ... كـ continuation

فأضف Features:

لو prevType = character و line يبدأ بـ dash أو ellipsis → dialogue++

لو السطر مليان ضمائر “أنا/إنت/إحنا” أو أسئلة “؟” → dialogue++

وبالمقابل:

لو السطر يبدأ بنمط حركة قوي (نرى/نسمع/يدخل…) حتى لو prev character → أكشن (أنت بالفعل عامل جزء من ده، ممتاز)

5.5) Action

أقوى ترقية للأكشن عندك: مش لازم يبدأ بفعل أول كلمة.
في عربي كتير بيكتب:

“أحمد يدخل الغرفة” (اسم + فعل)

“الولد يجري” (اسم + فعل)

دي عندك هتروح ناحية character لو next line dialogue.

حل:

لو wordCount >= 2
و الكلمة التانية فعل (في verb set أو verb-like pattern)
ارفع action وقلل character.

ده وحده هيقلل false characters جامد.

6) أهم حاجة لاحتياط “كل الاحتمالات”: اختبارات توليدية Fuzz / Property-based

أنت بتقول: “مش هبقى مدرك كل الاحتمالات”… صح 100%.

الحل هنا مش إنك تتخيل كل الأخطاء… الحل إنك تولّد أخطاء.

6.1) اعمل Mutators للسطر

خد corpus صغير عندك (مقاطع مكتوبة صح) وطبّق عليه تحويلات عشوائية:

زيادة/نقصان مسافات

استبدال - بـ – بـ —

حذف : من سطور الشخصية

إضافة رموز BIDI زي \u200f

استبدال الأرقام العربية/الغربية

إضافة/حذف أقواس

وبعدين assert إن:

النوع مايتغيرش في الحالات اللي المفروض stable

أو على الأقل doubtScore يزيد (فتعرف إن الخطأ “اتلقط”)

في TypeScript هتلاقي fast-check ممتاز للموضوع ده.

6.2) Fuzz للتسلسل

مش بس السطر… كمان التسلسل:

ولّد sequence من (character/dialogue/action/…)

وبعدين “شوّه” سطور عشوائيًا

وشوف نظامك السياقي/الـ Viterbi هيرجعها لمسار منطقي ولا لأ.

ده بالذات هيثبت “فهم السياق” بشكل عملي.

7) خليك عملي: Logging + Learning Loop

في الإنتاج أو حتى أثناء التطوير:

لو doubtScore عالي أو confidence منخفض:

خزّن السطر + top2 reasons

وخلّيك تجمع “أشهر 50 حالة غموض”

وبكل دفعة:

إمّا تزود Rule صغيرة

أو تزود كلمة في dictionary

أو تزود test regression

ده بيحوّل النظام من “قواعد ثابتة” إلى “نظام بيتحسن تلقائيًا من الواقع”.