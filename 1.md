# دوال تصنيف التعرف على سطر راس المشهد 1-2-3

## نظرة عامة

ملف توثيقي يشرح دوال تصنيف التعرف على سطور رؤوس المشاهد (Scene Headers) في سيناريوهات المسرحيات والأفلام العربية.

## الملفات الأساسية

### 1. Scene Header Extractor
**الملف:** `src/lib/scene-header-extractor.ts`

#### الكلاس: `SceneHeaderExtractor`

**الوظيفة:** استخراج أجزاء ترويسة المشهد من مصفوفة الأسطر

```typescript
export class SceneHeaderExtractor {
  static extractSceneHeaderParts(lines: string[], startIndex: number): SceneHeaderParts | null
}
```

**النتيجة:**
```typescript
interface SceneHeaderParts {
  sceneNum: string;        // "مشهد 1" أو "م. 1"
  timeLocation: string;    // "داخلي-نهار" أو "ليل-خارجي"
  place: string;           // الوصف التفصيلي للمكان
  consumedLines: number;   // عدد الأسطر المستهلكة
}
```

### 2. Screenplay Line Classifier
**الملف:** `src/lib/screenplay-line-classifier.ts`

#### دوال التصنيف الأساسية

**`isSceneHeaderStart(line: string): boolean`**
- **الوظيفة:** التحقق من بدء السطر بترويسة مشهد
- **النمط:** يطابق `/^\s*(?:مشهد|م\.)\s*([0-9]+)\s*(?:[-–—:،]\s*)?(.*)$/i`

**`parseSceneHeaderFromLine(rawLine: string): object | null`**
- **الوظيفة:** تحليل ترويسة المشهد من سطر واحد
- **النتيجة:** `{ sceneNum, timeLocation, placeInline }`

**`extractSceneHeaderParts(lines: string[], startIndex: number): object | null`**
- **الوظيفة:** تجميع ترويسة المشهد الكاملة مع المكان من الأسطر التالية
- **النتيجة:** `{ sceneNum, timeLocation, place, consumedLines }`

## آلية العمل

### مراحل التعرف على ترويسة المشهد:

1. **الكشف عن بداية الترويسة:**
   - البحث عن كلمة "مشهد" أو "م." متبوعة برقم
   - قبول الأرقام العربية والإنجليزية
   - قبول الفواصل المختلفة (- – — : ،)

2. **استخراج الجزء 1 (رقم المشهد):**
   - تنسيق: "مشهد 1" أو "م. 1"
   - يتم حفظه في: `scene-header-1`

3. **استخراج الجزء 2 (الوقت والمكان):**
   - الأنماط المدعومة:
     - "داخلي-نهار"، "خارجي-ليل"
     - "ليل-داخلي"، "نهار-خارجي"
     - الاختصارات: "د.ن.", "خ.ل.", "ل.د.", "ن.خ."
   - يتم حفظه في: `scene-header-2`

4. **استخراج الجزء 3 (وصف المكان):**
   - يمكن أن يكون في نفس السطر أو الأسطر التالية
   - يتوقف عند أول عنصر جديد (حوار، شخصية، انتقال)
   - يتم حفظه في: `scene-header-3`

## أمثلة على التصنيف

### مثال 1: ترويسة كاملة في سطر واحد
```
المدخل: "مشهد 1 - داخلي-نهار – القصر – غرفة العرش"
النتيجة:
- scene-header-1: "مشهد 1"
- scene-header-2: "داخلي-نهار"
- scene-header-3: "القصر – غرفة العرش"
```

### مثال 2: ترويسة مع مكان في سطرين
```
المدخل:
"مشهد 2 - ليل-خارجي"
"الحديقة الملكية"
"مع الإضاءة الخافتة"

النتيجة:
- scene-header-1: "مشهد 2"
- scene-header-2: "ليل-خارجي"
- scene-header-3: "الحديقة الملكية – مع الإضاءة الخافتة"
```

### مثال 3: ترويسة مختصرة
```
المدخل: "م. 3 - د.ن. – المكتب"
النتيجة:
- scene-header-1: "م. 3"
- scene-header-2: "د.ن."
- scene-header-3: "المكتب"
```

## الأنماط المنتظمة المستخدمة

```typescript
// نمط ترويسة المشهد
const SCENE_PREFIX_RE = /^\s*(?:مشهد|م\.)\s*([0-9]+)\s*(?:[-–—:،]\s*)?(.*)$/i

// نمط الوقت والمكان
const INOUT_PART = '(?:داخلي|خارجي|د\.|خ\.)'
const TIME_PART = '(?:ليل|نهار|ل\.|ن\.|صباح|مساء|فجر|ظهر|عصر|مغرب|الغروب|الفجر)'
const TL_REGEX = new RegExp(
  String.raw`(?:${INOUT_PART}\s*-?\s*${TIME_PART}|${TIME_PART}\s*-?\s*${INOUT_PART})`,
  'i'
)
```

## التكامل مع المصنف الرئيسي

في دالة `classifyDocument()`، يتم استخدام النتائج كالتالي:

```typescript
if (isSceneHeaderStart(line)) {
  const parts = extractSceneHeaderParts(lines, idx)
  if (parts) {
    out['scene-header-1'].push(sceneNum)
    if (timeLocation) out['scene-header-2'].push(timeLocation)
    if (place) out['scene-header-3'].push(place)
  }
}
```

## اختبارات الوحدة

الملفات التالية تحتوي على اختبارات شاملة:
- `src/lib/scene-header-extractor.test.ts`
- `src/lib/screenplay-line-classifier.test.ts`

## ملاحظات مهمة

1. **الترتيب:** يجب أن تكون ترويسة المشهد أول عنصر في المشهد
2. **التوقف:** يتوقف جمع المكان عند أول عنصر جديد (حوار، شخصية، انتقال)
3. **التوحيد:** يتم توحيد الفواصل إلى شرطة (-) دائمًا
4. **الحساسية:** غير حساس لحالة الأحرف (i flag في Regex)
