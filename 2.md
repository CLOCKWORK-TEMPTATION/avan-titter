1) أصل المشكلة: التصنيف الجشع Greedy ينهار عند الكتابة الحية

حتى لو كانت دوال النقاط ممتازة، اتخاذ قرار كل سطر بمعزل (أو بنافذة 3 أسطر) يسبب أخطاء من نوع:

سطر “اسم شخصية” بدون نقطتين أثناء الكتابة → يُقرأ Action.

سطر يبدأ بشرطة “-” داخل بلوك حوار → يُقرأ Action لأن عندك تعزيز قوي للشرطة في الأكشن.

رؤوس مشاهد متعددة السطور → السطر الثاني يتصنف Action لأنه لا يبدأ بـ “مشهد …”.

الحل: اعتبر النص “سلسلة حالات”، وليس “سطر مستقل”.

2) تطوير السياق: اجعله Context “منطقي” وليس “نافذة ثابتة”
(أ) لا تعامل السطر الفارغ كـ Action داخل السياق

حاليًا في classifyBatch السطر الفارغ يُدفع كـ type: "action" وتُسجّل previousTypes[i] = "action".
هذا يلوّث السياق: بلوك الحوار ينقطع بسبب “Action وهمي”.

التطوير المقترح

داخليًا أثناء التصنيف: استخدم نوعًا مستقلًا مثل blank.

وفي مرحلة الإخراج/التنسيق فقط قرر كيف يتم تمثيله (Spacing).

أثر مباشر: scoreAsDialogue و scoreAsCharacter سيعملان بواقعية لأن “السطر السابق” يصبح فعليًا السابق غير الفارغ.

(ب) سياق “غير فارغ” + حدود بلوكات

بدل WINDOW_SIZE = 3 كقيمة ثابتة:

اجلب prevNonBlank, prev2NonBlank, nextNonBlank

وحدد “حدود البلوك” عند:

scene-header-*

transition

blank

بداية بلوك حوار (character)

وبالتالي يصبح السياق سياقًا بنيويًا لا مجرد نافذة.

3) ذاكرة داخل المستند: أهم ترقيعة عملية ضد احتمالات الكاتب

أقوى احتياط عملي عند الكتابة الحية: قاموس يتعلم من المستند نفسه.

(أ) قاموس الشخصيات

كلما صُنّف سطر character استخرج الاسم (مع/بدون “:”) وخزّنه في knownCharacters.

لاحقًا: أي سطر قصير يطابق شكل الاسم، إذا كان موجودًا في القاموس يحصل على Boost كبير حتى لو الكاتب لم يكتب “:”.

هذا يعالج 80% من أخطاء “الكاتب لسه بيكتب ومكملش العلامات”.

(ب) قاموس الأماكن/العناوين

نفس الفكرة لرأس المشهد متعدد السطور:

خزّن الأماكن التي ظهرت في رؤوس مشاهد سابقة.

استخدمها كـ Boost للسطر التالي بعد scene-header-top-line.

4) “السياق هو كلمة السر” عمليًا: حوّله إلى Grammar (State Machine)

عرّف قواعد مسموحة للتتابع. مثال عملي:

بلوك الحوار

character

ثم اختياريًا: parenthetical (مرة أو أكثر)

ثم: dialogue (سطر أو أكثر)

ثم ينتهي عند: blank أو transition أو scene-header-* أو action قوي

بلوك رأس المشهد متعدد السطور

scene-header-top-line (مشهد + رقم)

ثم 0..2 أسطر من “تكملة الرأس” (داخلي/خارجي/مكان/وقت)

ثم يبدأ action

هنا تصبح جملة “الشرطة = أكشن” مشروطة بالسياق:

إذا كنت داخل بلوك حوار: الشرطة غالبًا “استكمال حوار” أو “نبرة” وليست أكشن.

إذا كنت خارج بلوك حوار: الشرطة قد تكون أكشن أو Bullet.

5) القرار النهائي: بدل أعلى Score لكل سطر → استخدم Viterbi على السلسلة

هذه أكبر نقلة جودة بأقل تعقيد منطقي:

اعتبر scoreAsX = Emission Score

أضف جدول Transition Score بين الأنواع (مثال: character→dialogue عالي، dialogue→scene-header منخفض جدًا…)

شغّل Viterbi لتحصل على “أفضل مسار أنواع” لكل السطور.

ميزة ذلك: سطر واحد غامض لا يُفسد البلوك كله؛ المسار العام سيُصحح نفسه.

6) تحسينات موجهة لكل عنصر (احتياطات ضد أخطاء الكاتب)
(1) Character

أخطاء متوقعة

بدون “:”

اسم + لقب طويل

“صوت فلان” أو “من خارج الكادر”

احتياطات

Boost إذا الاسم ضمن knownCharacters

Boost إذا السطر التالي “يبدو حوارًا” حتى بدون “:”

Penalty إذا بدأت الجملة بفعل حركي (عندك بالفعل) أو انتهت بعلامات جملة بدون “:”

(2) Dialogue

أخطاء متوقعة

سطر حوار قصير جدًا

يبدأ بشرطة داخل الحوار

احتياطات

داخل بلوك حوار: الشرطة لا تعطي أكشن؛ أعطها Boost للحوار

اعتبر استمرار الحوار (prev dialogue) حالة طبيعية حتى لو لا توجد علامات ترقيم

(3) Parenthetical

أخطاء متوقعة

الكاتب يكتبها بدون أقواس: “بهمس” “ساخرًا”

احتياطات

إذا prevType = character وكان السطر قصيرًا ويبدأ بكلمات parenthetical الشائعة → اعتبره parenthetical حتى بدون أقواس (بثقة متوسطة) أو اقترح تلقائيًا إضافة أقواس في الـ UI.

(4) Scene Header

أخطاء متوقعة

رأس متعدد السطور: “مشهد 12” ثم في السطر التالي “داخلي – بيت – ليل”

حذف الرقم مؤقتًا أثناء الكتابة

احتياطات

بعد scene-header-top-line: عامل السطر التالي كمرشح قوي لـ “تكملة رأس المشهد” إذا احتوى (داخلي/خارجي/وقت/مكان معروف)

لو الرقم غير مكتمل: خفّض الثقة ولا تُسقطه مباشرة إلى action؛ اجعله “pending header” لحين كتابة الرقم أو الانتقال للسطر التالي

(5) Action

أخطاء متوقعة

سطر أكشن قصير جدًا قد يشبه اسم شخصية

Bullet Lists

احتياطات

فعّل تمييز bullet الحقيقي (• / -) كنوع فرعي أو “action-bullet”

الشرطية “-” لا تكفي وحدها: اربطها بالسياق (داخل الحوار ≠ أكشن)

(6) Transition

أخطاء متوقعة

صيغ عربية كثيرة: “إظلام” “إلى السواد” “قطع على”

احتياطات

وسّع القاموس تدريجيًا بناءً على نصوص المستخدم الفعلية (log + whitelist)

7) إدارة الشك: استخدم doubtScore كميزة منتج وليس رقمًا داخليًا

بدل أن “تقرر وخلاص”:

إذا confidence = low أو doubtScore فوق عتبة:

لا تغيّر تنسيق السطر نهائيًا

ضع علامة “غير مؤكّد”

واسمح للمستخدم بتثبيت النوع بسرعة (اختصار/زر)

وخزّن التصحيح لتحسين knownCharacters/knownPlaces فورًا

هذا يحول “الاحتمالات التي لا تدركها” إلى بيانات تدريب داخلية للمستند نفسه.

8) خطة تنفيذ قصيرة وفعّالة (بالترتيب)

افصل blank عن action داخليًا، واجعل السياق يتخطى الفراغات.

أضف قاموس شخصيات يتعلم من الملف أثناء التصنيف.

عدّل قواعد الشرطة “-” لتكون مشروطة بالسياق (داخل الحوار لا تُحسب أكشن).

أضف حالة تكملة رأس المشهد بعد scene-header-top-line.

(قفزة كبيرة) نفّذ Viterbi: emission من scoreAs* + transition table.